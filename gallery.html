<div id="scatterplots" class="container-fluid">
  <div class="row">
    <div id="info" class="col-sm-1">
      <div>
        <ul id="words" class="scrollbox20 nolist"></ul>
      </div>
    </div>
         
    <div id="main_scatterplot" class="scatterplot col-sm-4 right-divider"></div>
    <div id="cluster_scatterplot" class="scatterplot col-sm-4"></div>

    <div id="barchart" class="col-sm-3 scatterplot"></div>   
  </div>
</div>

<div>
  <select id="dimension_select"></select>
  <svg width="500" height="50" id="slider"></svg>
</div>


<div>
  <h3 id="reset">Reset</h3>
</div>

<div id="clusters" class="container-fluid">
  <div class="row" id="clusters_row">
  </div>
</div>

<div id="embeddings" class="container-fluid">
  <div class="row" id="embeddings_row">
  </div>
</div>

<script>
function updateBarchart(point) {
  // HACK
  d3.select("#barchart").style("opacity", 1);
  
  var margin = { top: 0, right: 5, bottom: 0, left: 5 };
  
  var width = 275 - margin.left - margin.right;
  // X scale
  var x = d3.scaleLinear().domain([-3, 3]).range([0, width]);

  var colorScale = d3.scaleLinear().range([0, 1]).domain([-3, 3]);
  
  var data = [];
  for (var i = 0; i < 10; i++) {
    data.push({
      i: i,
      name: "dim" + i,
      value: point["dim" + i]      
    });
    
    var v = point["dim" + i];
    d3.select("#bar" + i)
      .transition().delay(0).duration(200)
      .attr('class', function (d) {
        return "bar bar--" + (v < 0 ? "negative" : "positive");
      })
      .attr("fill", function(d) { return d3.interpolateRdBu(colorScale(v)); })
      .attr('x', function (d) {return margin.left + x(Math.min(0, v));})
      .attr('width', function (d) {return Math.abs(x(v) - x(0));})
      .attr('height', 45);
      
      /*
      .attr('x', function (d) {return x(Math.min(0, point["dim" + i]));})      
      .attr('width', function (d) {return Math.abs(x(point["dim" + i]) - x(0));});*/
  };    
}
function barchart(point) {
  var data = [];
  for (var i = 9; i >= 0; i--) {
    data.push({
      i: i,
      name: "dim" + i,
      value: point["dim" + i]
    });
  }

  var margin = { top: 0, right: 5, bottom: 0, left: 5 };
  var height = 500 - margin.top - margin.bottom;
  var width = 275 - margin.left - margin.right;

  // Add svg to
  var svg = 
    d3.select('#barchart')
      .append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
      .append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  // X scale
  var x = d3.scaleLinear().domain([-3, 3]).range([0, width]);
  var y = d3.scaleBand().domain(data.map(function (d) {return d.name;})).rangeRound([height, 0]);


  var yAxis = 
    d3.axisLeft(y);


  svg
    .selectAll('.bar')
    .data(data)
    .enter().append('rect')
      .attr("id", function(d) { return "bar" + d.i; })
      .attr('x', function (d) {return x(Math.min(0, d.value));})
      .attr('y', function (d) {return y(d.name);})
      .attr('width', function (d) {return Math.abs(x(d.value) - x(0));})
      .attr('height', 40);
};
function getPoints(data) {
  var keys = data["columns"];
  
  var points = [];
  for (var i = 0; i < data["data"].length; i++) {
    var p = {};
    
    for (var j = 0; j < keys.length; j++) {
      p[keys[j]] = data["data"][i][j];
    }
    
    points.push(p);
  };  
  
  return points;
}
d3.json("data/embedding.json", function(err, data) {
  var WIDTH = 500,
      HEIGHT = 500;
    
  var points = getPoints(data);
  
  // HACK  
  barchart(points[0]);
  d3.select("#barchart").style("opacity", 0);
  
  
  var color = d3.scaleOrdinal(d3.schemeCategory20);
  
  var svg = 
    d3.select("#main_scatterplot")
      .append("svg")
      .attr("width", WIDTH)
      .attr("height", HEIGHT);
      
      // setup x 
      var xValue = function(d) { return d["t0"]; }, // data -> value
          xScale = d3.scaleLinear().range([0, WIDTH]), // value -> display
          xMap = function(d) { return xScale(xValue(d));}; // data -> display

      // setup y
      var yValue = function(d) { return d["t1"]; }, // data -> value
          yScale = d3.scaleLinear().range([HEIGHT, 0]), // value -> display
          yMap = function(d) { return yScale(yValue(d));}; // data -> display      

      xScale.domain([d3.min(points, xValue) - 1, d3.max(points, xValue) + 1]);
      yScale.domain([d3.min(points, yValue) - 1, d3.max(points, yValue) + 1]);
            
      
  var origSvg = svg;
      
  var svgChild = 
    d3.select("#cluster_scatterplot")
      .append("svg")
      .attr("width", WIDTH)
      .attr("height", HEIGHT);      

  var tooltip = d3.select("body").append("div")	
      .attr("class", "tooltip")
      .style("opacity", 0);

  var circles = [];
                        
  function draw(selector, data, cluster = -1) {
    selector.html("");
    
    selector.selectAll("circle")
      .data(data)
      .enter()
      .append("circle")
      .attr("cx", xMap)
      .attr("cy", yMap)
      .style("stroke", "black")
      .style("stroke-opacity", function(d) {
        if (cluster != -1) {
          if (d.cluster == cluster) {
            return 1.0;
          } else {
            return 0.2;
          }
        } else {
          return 0.2;
        }        
      })
      .attr("r", function(d) {
        if (cluster != -1) {
          if (d.cluster == cluster) {
            return 5;
          } else {
            return 3;
          }
        } else {
          return 3;
        }        
      })
      .attr('fill-opacity', function(d) {
        if (cluster != -1) {
          if (d.cluster == cluster) {
            return 0.95;
          } else {
            return 0.05;
          }
        } else {
          return 0.8;
        }
      })      
      .style("fill", function(d) { return color(d.cluster); })
      .on("mouseenter", function(d) {
        updateBarchart(d);
        
        var r = 3;
        if (cluster != -1) {
          if (d.cluster == cluster) {
            r = 5;
          } else {
            r = 3;
          }
        } else {
          r = 3;
        }
        d3.select(this).transition().delay(0).duration(75).attr("r", 20).attr("fill-opacity", 1).attr("stroke-width", 2).attr("stroke-opacity", 1).transition().duration(75).attr("r", 10);
        
        //.transition();//.duration(300).attr("r", r);
//        d3.select(this).attr("r", 15);
        d3.select("#words").insert("li", ":first-child").text(d.word).style("color", color(d.cluster));

        tooltip
          .transition()
          .duration(200)
          .style("opacity", 1);

        tooltip
          .text(d.word)
          .style("left", (d3.event.pageX) + "px")		
          .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout", function(d) {        
        tooltip.html("");
        var r = 3;
        if (cluster != -1) {
          if (d.cluster == cluster) {
            r = 5;
          } else {
            r = 3;
          }
        } else {
          r = 3;
        }
        d3.select(this).transition().duration(750).attr("r", r).attr("stroke-width", 1).style("stroke-opacity", function(d) {
          if (cluster != -1) {
            if (d.cluster == cluster) {
              return 1.0;
            } else {
              return 0.2;
            }
          } else {
            return 0.2;
          }        
        });
      });
  }
  draw(svg, points, -1);
     
  $("#reset").on("click", function(d) {    
    draw(svg, points, -1);
  });
  var num_clusters = _.unique(_.map(points, function(x) { return x["cluster"]; }));
  for (var i = 0; i < num_clusters.length; i++) {
    var clusterPoints = _.filter(points, function(x) { return x["cluster"] == i; });
    var samples = _.sample(clusterPoints, 50);
    
    var cluster = d3.select("#clusters_row")
      .append("div")
      .attr("class", "col-md-3");
    
    cluster
      .datum([i, clusterPoints])
      .append("h5").html("<span class='linklike'>Cluster " + (i + 1) + "</span>").classed("linklike", true).style("color", function(d) { return color(d[0]); })
      .on("click", function(d) {
        var i = d[0];
        var clusterPoints = d[1];
        draw(svg, points, i);
        draw(svgChild, clusterPoints, i, true);
      });
      
    
    cluster
      .append("ul").classed("scrollbox", true)    
      .selectAll("li")
      .data(samples)
      .enter()
      .append("li")
      .html(function(x) { return x["word"]; });
  }
  
  d3
    .select("#dimension_select")
    .selectAll("option")
    .data([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
    .enter()
    .append("option").attr("value", function(i) { return i+1; }).text(function(i) { return "Dimension " + (i+1); });
  d3.select("#dimension_select")
    .on("change", function() {
      console.log("HMM");
      sd = +d3.select(this).property("value") - 1;
      console.log(sd);
      createSlider(sd);
    });
  
  createSlider(0);
  for (var i = 0; i < 10; i++) {
    
    
    var ps = _.sortBy(points, function(x) { return x["dim" + i]; });
    var topPs = _.last(ps, 10).reverse();
    var bottomPs = _.first(ps, 10);
    
    var embeddings = 
      d3.select("#embeddings_row")
        .append("div")
        .attr("class", "col-md-4 embedding");
        
    embeddings
      .datum(i)
      .append("h3").text("Dimension " + (i + 1))
      .on("click", function(i) {
        console.log(i);
        var dimd = "dim" + i;
        var ds = _.sortBy(_.map(points, function(x) { return x[dimd]; }), function(x) { return x; });
        var qs = _.map([0, 0.05, 0.5, 0.95, 1.0], function(q) { return d3.quantile(ds, q); });
        console.log(qs);
        var p1s = _.filter(points, function(x) { return (x[dimd] >= qs[0] && x[dimd] <= qs[1]); });
        var p2s = _.filter(points, function(x) { return (x[dimd] >= qs[1] && x[dimd] <= qs[2]); });
        var p3s = _.filter(points, function(x) { return (x[dimd] >= qs[2] && x[dimd] <= qs[3]); });
        var p4s = _.filter(points, function(x) { return (x[dimd] >= qs[3] && x[dimd] <= qs[4]); });                        
        
        var s1 = 
          d3.select("#s1").html("")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);
        draw(s1, p1s);

        var s2 = 
          d3.select("#s2").html("")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);
        draw(s2, p2s);
        
        var s3 = 
          d3.select("#s3").html("")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);
        draw(s3, p3s);
        
        var s4 = 
          d3.select("#s4").html("")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);
        draw(s4, p4s);
                                
      });
      
    var row = 
      embeddings.append("div").classed("row", true)
      
    
    
    var embeddings1 = row
      .append("div")
      .attr("class", "col");
      
    var embeddings2 = row
      .append("div")
      .attr("class", "col");      
    
    embeddings1
      .datum([i, topPs, bottomPs])
      .append("h5").text("Low")
      .append("ul");
      
      embeddings2
        .datum([i, topPs, bottomPs])
        .append("h5").text("High")
        .append("ul");        
      

    embeddings1
      .selectAll("li")
      .data(bottomPs)
      .enter()
      .append("li")
      .html(function(x) { return x["word"]; });    
      
      embeddings2
        .selectAll("li")
        .data(topPs)
        .enter()
        .append("li")
        .html(function(x) { return x["word"]; });      
  }
  
  
  function createSlider(sDim) {
    //dim9 = music
    var sliderDim = "dim" + sDim;
    var dim0 = _.map(points, function(p) { return p[sliderDim]; });  
    var dim0_min = _.min(dim0);
    var dim0_max = _.max(dim0);

    var sliderSvg = d3.select("#slider").html(""),
        margin = {right: 50, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = 20;

    var x = d3.scaleLinear()
        .domain([dim0_min, dim0_max])
        .range([0, width])
        .clamp(true);

    var slider = sliderSvg.append("g")
        .attr("class", "slider")
        .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

    slider.append("line")
        .attr("class", "track")
        .attr("x1", x.range()[0])
        .attr("x2", x.range()[1])
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
        .attr("class", "track-inset")
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
        .attr("class", "track-overlay")
        .call(d3.drag()
            .on("start.interrupt", function() { slider.interrupt(); })
            .on("start drag", function() { hue(x.invert(d3.event.x)); }));

    slider.insert("g", ".track-overlay")
        .attr("class", "ticks")
        .attr("transform", "translate(0," + 18 + ")")
      .selectAll("text")
      .data(x.ticks(10))
      .enter().append("text")
        .attr("x", x)
        .attr("text-anchor", "middle")
        .text(function(d) { return d; });

    var handle = slider.insert("circle", ".track-overlay")
        .attr("class", "handle")
        .attr("r", 9);    
        
    function hue(h) {
      handle.attr("cx", x(h));

      origSvg.selectAll("circle").data(points)
        .attr("r", function(p) {
          var x  =Math.pow(sigmoid(1.0 / (Math.pow(h - p[sliderDim], 2) + 0.01)), 5) * 10 ;
          return x;
        })
        .attr("fill-opacity", function(p) {
          return Math.pow(sigmoid(1.0 / (Math.pow(h - p[sliderDim], 2) + 0.01)), 5) * 0.6;
        })

        svgChild.selectAll("circle").data(points)
          .attr("r", function(p) {
            var x  =Math.pow(sigmoid(1.0 / (Math.pow(h - p[sliderDim], 2) + 0.01)), 5) * 10 ;
            return x;
          })
          .attr("fill-opacity", function(p) {
            return Math.pow(sigmoid(1.0 / (Math.pow(h - p[sliderDim], 2) + 0.01)), 5) * 0.6;
          })      
    }        
  }


  function sigmoid(t) {
    return 1/(1+Math.pow(Math.E, -t));
  }


  
  
});
</script>